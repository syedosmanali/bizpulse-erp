{% extends 'erp_base_layout.html' %}

{% block title %}CRM & Leads - ERP System{% endblock %}

{% block extra_css %}
<style>

        :root { --wine: #732C3F; --wine2: #B85450; --bg: #F9F6F7; --card: #fff; --text: #1A1A1A; --sub: #6B7280; --border: rgba(0,0,0,0.08); --radius: 12px; }
        * { margin:0; padding:0; box-sizing:border-box; }
        body { font-family:'Inter',sans-serif; background:var(--bg); color:var(--text); min-height:100vh; }
        .top-bar { background:var(--wine); color:#fff; padding:14px 20px; display:flex; align-items:center; gap:12px; position:sticky; top:0; z-index:100; }
        .back-btn { background:rgba(255,255,255,0.2); border:none; color:#fff; width:36px; height:36px; border-radius:8px; cursor:pointer; font-size:18px; }
        .top-bar h1 { font-size:17px; font-weight:600; flex:1; }
        .tabs { display:flex; background:var(--card); border-bottom:1px solid var(--border); }
        .tab { flex:1; padding:12px; text-align:center; font-size:13px; font-weight:500; cursor:pointer; color:var(--sub); border-bottom:2px solid transparent; }
        .tab.active { color:var(--wine); border-bottom-color:var(--wine); font-weight:600; }
        .tab-content { display:none; }
        .tab-content.active { display:block; }
        .container { max-width:700px; margin:0 auto; padding:16px; }
        .card { background:var(--card); border-radius:var(--radius); padding:16px; margin-bottom:14px; box-shadow:0 1px 4px rgba(0,0,0,0.06); }
        .card-title { font-size:14px; font-weight:600; color:var(--wine); margin-bottom:14px; display:flex; align-items:center; justify-content:space-between; }
        .form-group { margin-bottom:12px; }
        label { display:block; font-size:12px; font-weight:500; color:var(--sub); margin-bottom:4px; }
        input, select, textarea { width:100%; padding:10px 12px; border:1.5px solid var(--border); border-radius:8px; font-size:14px; font-family:'Inter',sans-serif; background:#fafafa; outline:none; }
        input:focus, select:focus, textarea:focus { border-color:var(--wine); background:#fff; }
        .form-row { display:grid; grid-template-columns:1fr 1fr; gap:12px; }
        .btn-primary { background:var(--wine); color:#fff; border:none; padding:11px 20px; border-radius:8px; font-size:14px; font-weight:600; cursor:pointer; }
        .btn-sm { padding:6px 12px; font-size:12px; border-radius:6px; border:none; cursor:pointer; font-weight:500; }
        .btn-danger { background:#fee2e2; color:#dc2626; }
        .btn-edit { background:#eff6ff; color:#2563eb; }
        .lead-item { background:#fafafa; border:1.5px solid var(--border); border-radius:10px; padding:14px; margin-bottom:10px; }
        .lead-item h3 { font-size:14px; font-weight:600; margin-bottom:4px; }
        .lead-item p { font-size:12px; color:var(--sub); margin-bottom:2px; }
        .status-badge { font-size:11px; padding:2px 8px; border-radius:20px; font-weight:500; }
        .s-new { background:#eff6ff; color:#2563eb; }
        .s-followup { background:#fef9c3; color:#ca8a04; }
        .s-converted { background:#dcfce7; color:#16a34a; }
        .s-lost { background:#fee2e2; color:#dc2626; }
        .stats-row { display:grid; grid-template-columns:repeat(4,1fr); gap:10px; margin-bottom:14px; }
        .stat-box { background:var(--card); border-radius:10px; padding:12px; text-align:center; box-shadow:0 1px 4px rgba(0,0,0,0.06); }
        .stat-box .num { font-size:22px; font-weight:700; color:var(--wine); }
        .stat-box .lbl { font-size:11px; color:var(--sub); margin-top:2px; }
        .reminder-item { background:#fafafa; border-left:3px solid var(--wine); border-radius:8px; padding:12px; margin-bottom:8px; }
        .reminder-item h4 { font-size:13px; font-weight:600; }
        .reminder-item p { font-size:12px; color:var(--sub); }
        .empty { text-align:center; padding:30px; color:var(--sub); font-size:14px; }
        .toast { position:fixed; bottom:24px; left:50%; transform:translateX(-50%); background:#1a1a1a; color:#fff; padding:10px 20px; border-radius:20px; font-size:13px; z-index:9999; opacity:0; transition:opacity 0.3s; }
        .toast.show { opacity:1; }
        @media(max-width:500px){ .form-row{grid-template-columns:1fr;} .stats-row{grid-template-columns:1fr 1fr;} }
    
</style>
{% endblock %}

{% block content %}

<div class="top-bar">
    <button class="back-btn" onclick="history.back()">‚Üê</button>
    <h1>ü§ù CRM</h1>
</div>
<div class="tabs">
    <div class="tab active" onclick="switchTab('leads')">üë§ Leads</div>
    <div class="tab" onclick="switchTab('followup')">üìû Follow-ups</div>
    <div class="tab" onclick="switchTab('reminders')">üîî Reminders</div>
    <div class="tab" onclick="switchTab('history')">üìú History</div>
</div>

<!-- LEADS TAB -->
<div id="tab-leads" class="tab-content active">
<div class="container">
    <div class="stats-row" id="crmStats">
        <div class="stat-box"><div class="num" id="s-total">0</div><div class="lbl">Total Leads</div></div>
        <div class="stat-box"><div class="num" id="s-new" style="color:#2563eb;">0</div><div class="lbl">New</div></div>
        <div class="stat-box"><div class="num" id="s-converted" style="color:#16a34a;">0</div><div class="lbl">Converted</div></div>
        <div class="stat-box"><div class="num" id="s-followup" style="color:#ca8a04;">0</div><div class="lbl">Follow-up</div></div>
    </div>
    <div class="card" id="addLeadCard" style="display:none;">
        <div class="card-title"><i data-lucide="plus"></i> Add Lead</div>
        <div class="form-row">
            <div class="form-group"><label>Name *</label><input id="l_name" placeholder="Lead name"></div>
            <div class="form-group"><label>Phone</label><input id="l_phone" type="tel" placeholder="<i data-lucide="plus"></i>91 9999999999"></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label>Email</label><input id="l_email" type="email" placeholder="email@example.com"></div>
            <div class="form-group"><label>Source</label>
                <select id="l_source"><option>Walk-in</option><option>Referral</option><option>Social Media</option><option>Advertisement</option><option>Other</option></select>
            </div>
        </div>
        <div class="form-row">
            <div class="form-group"><label>Follow-up Date</label><input id="l_followup" type="date"></div>
            <div class="form-group"><label>Status</label>
                <select id="l_status"><option value="new">New</option><option value="followup">Follow-up</option><option value="converted">Converted</option><option value="lost">Lost</option></select>
            </div>
        </div>
        <div class="form-group"><label>Notes</label><textarea id="l_notes" rows="2" placeholder="Notes about this lead..."></textarea></div>
        <div style="display:flex;gap:10px;">
            <button class="btn-primary" onclick="addLead()" style="flex:1;"><i data-lucide="save"></i> Save Lead</button>
            <button onclick="toggleAddForm()" style="background:#f3f4f6;color:var(--sub);border:none;padding:11px 20px;border-radius:8px;cursor:pointer;">Cancel</button>
        </div>
    </div>
    <div class="card">
        <div class="card-title">üë§ All Leads <button class="btn-sm" onclick="toggleAddForm()" style="background:var(--wine);color:#fff;"><i data-lucide="plus"></i> Add Lead</button></div>
        <div id="leadList"><div class="empty">Loading...</div></div>
    </div>
</div>
</div>

<!-- FOLLOW-UP TAB -->
<div id="tab-followup" class="tab-content">
<div class="container">
    <div class="card">
        <div class="card-title">üìû Pending Follow-ups</div>
        <div id="followupList"><div class="empty">Loading...</div></div>
    </div>
</div>
</div>

<!-- REMINDERS TAB -->
<div id="tab-reminders" class="tab-content">
<div class="container">
    <div class="card">
        <div class="card-title">üîî Reminders Today</div>
        <div id="reminderList"><div class="empty">Loading...</div></div>
    </div>
</div>
</div>

<!-- HISTORY TAB -->
<div id="tab-history" class="tab-content">
<div class="container">
    <div class="card">
        <div class="card-title">üìú Customer History</div>
        <div class="form-group"><input placeholder="Search customer name..." id="histSearch" oninput="searchHistory()"></div>
        <div id="historyList"><div class="empty">Search for a customer to see history</div></div>
    </div>
</div>
</div>

<div id="toast" class="toast"></div>
<script>
let leads=[];
function showToast(msg,ok=true){const t=document.getElementById('toast');t.textContent=msg;t.style.background=ok?'#1a1a1a':'#dc2626';t.classList.add('show');setTimeout(()=>t.classList.remove('show'),2500);}
function switchTab(tab){
    const tabs=['leads','followup','reminders','history'];
    document.querySelectorAll('.tab').forEach(t=>t.classList.remove('active'));
    document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));
    document.querySelectorAll('.tab')[tabs.indexOf(tab)].classList.add('active');
    document.getElementById('tab-' <i data-lucide="plus"></i> tab).classList.add('active');
    if(tab!=='leads')loadLeads();
}
function toggleAddForm(){const f=document.getElementById('addLeadCard');f.style.display=f.style.display==='none'?'block':'none';}
function getStatusClass(s){return s==='new'?'s-new':s==='followup'?'s-followup':s==='converted'?'s-converted':'s-lost';}
async function loadLeads(){
    try{
        const r=await fetch('/api/erp/leads');const d=await r.json();
        if(d.success){
            leads=d.data||[];
            updateStats();renderLeads();renderFollowups();renderReminders();
        }
    }catch(e){document.getElementById('leadList').innerHTML='<div class="empty">Failed to load leads</div>';}
}
function updateStats(){
    document.getElementById('s-total').textContent=leads.length;
    document.getElementById('s-new').textContent=leads.filter(l=>l.status==='new').length;
    document.getElementById('s-converted').textContent=leads.filter(l=>l.status==='converted').length;
    document.getElementById('s-followup').textContent=leads.filter(l=>l.status==='followup').length;
}
function renderLeads(){
    const el=document.getElementById('leadList');
    if(!leads.length){el.innerHTML='<div class="empty">No leads yet. Add your first lead!</div>';return;}
    el.innerHTML=leads.map(l=>`<div class="lead-item">
        <div style="display:flex;justify-content:space-between;align-items:flex-start;">
            <div>
                <h3>${l.name} <span class="status-badge ${getStatusClass(l.status)}">${l.status}</span></h3>
                <p>üìû ${l.phone||'‚Äî'} &nbsp; Source: ${l.source||'‚Äî'}</p>
                ${l.follow_up_date?`<p><i data-lucide="calendar-clock"></i> Follow-up: ${l.follow_up_date}</p>`:''}
                ${l.notes?`<p>üìù ${l.notes}</p>`:''}
            </div>
            <div style="display:flex;flex-direction:column;gap:6px;">
                <button class="btn-sm btn-edit" onclick="editLead('${l.id}')"><i data-lucide="edit-2"></i></button>
                <button class="btn-sm btn-danger" onclick="deleteLead('${l.id}')"><i data-lucide="trash-2"></i></button>
            </div>
        </div>
    </div>`).join('');
}
function renderFollowups(){
    const today=new Date().toISOString().split('T')[0];
    const el=document.getElementById('followupList');
    const pending=leads.filter(l=>l.status==='followup'||(l.follow_up_date&&l.follow_up_date<=today));
    if(!pending.length){el.innerHTML='<div class="empty"><i data-lucide="package-check"></i> No pending follow-ups</div>';return;}
    el.innerHTML=pending.map(l=>`<div class="lead-item">
        <h3>${l.name}</h3>
        <p>üìû ${l.phone||'‚Äî'} &nbsp; Due: ${l.follow_up_date||'‚Äî'}</p>
        ${l.notes?`<p>üìù ${l.notes}</p>`:''}
    </div>`).join('');
}
function renderReminders(){
    const today=new Date().toISOString().split('T')[0];
    const el=document.getElementById('reminderList');
    const due=leads.filter(l=>l.follow_up_date===today);
    if(!due.length){el.innerHTML='<div class="empty">No reminders for today</div>';return;}
    el.innerHTML=due.map(l=>`<div class="reminder-item"><h4>üîî ${l.name}</h4><p>üìû ${l.phone||'‚Äî'}</p>${l.notes?`<p>${l.notes}</p>`:''}</div>`).join('');
}
async function addLead(){
    const name=document.getElementById('l_name').value.trim();
    if(!name){showToast('Lead name is required',false);return;}
    const payload={name,phone:document.getElementById('l_phone').value,email:document.getElementById('l_email').value,source:document.getElementById('l_source').value,status:document.getElementById('l_status').value,notes:document.getElementById('l_notes').value,follow_up_date:document.getElementById('l_followup').value};
    try{
        const r=await fetch('/api/erp/leads',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        const d=await r.json();
        if(d.success){showToast('<i data-lucide="package-check"></i> Lead added!');toggleAddForm();['l_name','l_phone','l_email','l_notes','l_followup'].forEach(id=>document.getElementById(id).value='');loadLeads();}
        else showToast('<i data-lucide="x"></i> ' <i data-lucide="plus"></i> d.error,false);
    }catch(e){showToast('<i data-lucide="x"></i> Network error',false);}
}
function editLead(id){
    const lead=leads.find(l=>l.id===id);
    if(!lead)return;
    document.getElementById('l_name').value=lead.name;
    document.getElementById('l_phone').value=lead.phone||'';
    document.getElementById('l_email').value=lead.email||'';
    document.getElementById('l_source').value=lead.source||'Walk-in';
    document.getElementById('l_status').value=lead.status||'new';
    document.getElementById('l_notes').value=lead.notes||'';
    document.getElementById('l_followup').value=lead.follow_up_date||'';
    toggleAddForm();
    showToast('Edit lead details and save');
}
async function deleteLead(id){
    if(!confirm('Delete this lead?'))return;
    try{await fetch(`/api/erp/leads/${id}`,{method:'DELETE'});showToast('Lead deleted');loadLeads();}catch(e){}
}
async function searchHistory(){
    const q=document.getElementById('histSearch').value.trim();
    if(!q){document.getElementById('historyList').innerHTML='<div class="empty">Search for a customer to see history</div>';return;}
    try{
        const r=await fetch(`/api/customers/search?q=${encodeURIComponent(q)}`);const d=await r.json();
        const el=document.getElementById('historyList');
        if(d.success&&d.customers&&d.customers.length){
            el.innerHTML=d.customers.map(c=>`<div class="lead-item"><h3>${c.name}</h3><p>üìû ${c.phone||'‚Äî'}</p></div>`).join('');
        } else {el.innerHTML='<div class="empty">No customer found</div>';}
    }catch(e){document.getElementById('historyList').innerHTML='<div class="empty">Search not available</div>';}
}
loadLeads();
</script>

{% endblock %}

{% block extra_js %}
<script>
lucide.createIcons();
</script>
{% endblock %}
