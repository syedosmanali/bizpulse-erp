{% extends "erp_base_layout.html" %}

{% block title %}Products Management - ERP{% endblock %}

{% block extra_css %}
<style>
:root {
    --wine: #732C3F;
    --wine-light: #8d3a4f;
    --bg: #f8f9fa;
    --text: #1A1A1A;
    --sub: #6B7280;
    --border: #e5e7eb;
    --radius: 12px;
}

.page-wrapper { background: var(--bg); min-height: 100vh; padding: 24px 20px; }
.page-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px; gap: 16px; }
.page-header h1 { font-size: 28px; font-weight: 700; color: var(--text); display: flex; align-items: center; gap: 12px; }
.page-header h1 i { color: var(--wine); }
.stats-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 16px; margin-bottom: 24px; }
.stat-card { background: #fff; border-radius: var(--radius); padding: 20px; border: 1px solid var(--border); box-shadow: 0 2px 4px rgba(0,0,0,0.05); }
.stat-card h3 { font-size: 14px; font-weight: 600; color: var(--sub); margin-bottom: 8px; text-transform: uppercase; letter-spacing: 0.5px; }
.stat-card .value { font-size: 28px; font-weight: 700; color: var(--wine); }
.stat-card .trend { font-size: 13px; margin-top: 4px; }
.trend.up { color: #10B981; }
.trend.down { color: #EF4444; }
.filters { display: flex; gap: 12px; margin-bottom: 20px; flex-wrap: wrap; align-items: center; }
.filter-select { padding: 10px 14px; border: 1.5px solid var(--border); border-radius: 8px; font-size: 14px; background: #fff; min-width: 150px; }
.action-btn { padding: 10px 16px; background: var(--wine); color: #fff; border: none; border-radius: 8px; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; transition: all 0.2s; }
.action-btn:hover { background: var(--wine-light); transform: translateY(-1px); }
.table-container { background: #fff; border-radius: var(--radius); border: 1px solid var(--border); overflow: hidden; box-shadow: 0 2px 8px rgba(0,0,0,0.08); }
.table { width: 100%; border-collapse: collapse; }
.table th { background: #f8fafc; padding: 14px 16px; text-align: left; font-weight: 600; color: var(--text); border-bottom: 1px solid var(--border); font-size: 14px; }
.table td { padding: 14px 16px; border-bottom: 1px solid var(--border); color: var(--text); }
.table tr:last-child td { border-bottom: none; }
.table tr:hover { background: #f8fafc; }
.status-badge { padding: 4px 10px; border-radius: 20px; font-size: 12px; font-weight: 600; }
.status-active { background: #dcfce7; color: #166534; }
.status-inactive { background: #fee2e2; color: #991b1b; }
.pagination { display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 0 16px; }
.page-info { font-size: 14px; color: var(--sub); }
.page-controls { display: flex; gap: 8px; }
.page-btn { padding: 8px 12px; border: 1px solid var(--border); background: #fff; border-radius: 6px; cursor: pointer; font-size: 13px; }
.page-btn:hover:not(:disabled) { background: var(--wine); color: #fff; border-color: var(--wine); }
.page-btn:disabled { opacity: 0.5; cursor: not-allowed; }
.page-btn.active { background: var(--wine); color: #fff; border-color: var(--wine); }
@media (max-width: 768px) {
    .page-wrapper { padding: 16px 12px; }
    .page-header { flex-direction: column; align-items: flex-start; gap: 12px; }
    .page-header h1 { font-size: 24px; }
    .filters { flex-direction: column; align-items: stretch; }
    .filter-select { width: 100%; }
    .stats-grid { grid-template-columns: 1fr; }
}
</style>
{% endblock %}

{% block content %}
<div class="page-wrapper">
    <div class="page-header">
        <h1>
            <i data-lucide="package"></i>
            Product Master
        </h1>
        <button class="action-btn" onclick="showAddProductModal()">
            <i data-lucide="plus"></i>
            Add Product
        </button>
    </div>
    
    <div class="stats-grid">
        <div class="stat-card">
            <h3>Total Products</h3>
            <div class="value" id="totalProducts">0</div>
        </div>
        <div class="stat-card">
            <h3>Active Products</h3>
            <div class="value" id="activeProducts">0</div>
        </div>
        <div class="stat-card">
            <h3>Low Stock</h3>
            <div class="value" id="lowStock">0</div>
        </div>
        <div class="stat-card">
            <h3>Out of Stock</h3>
            <div class="value" id="outOfStock">0</div>
        </div>
    </div>
    
    <div class="filters">
        <select class="filter-select" id="categoryFilter">
            <option value="">All Categories</option>
        </select>
        <select class="filter-select" id="statusFilter">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
        </select>
        <input type="text" class="filter-select" id="searchInput" placeholder="Search products...">
    </div>
    
    <div class="table-container">
        <table class="table">
            <thead>
                <tr>
                    <th>Product Name</th>
                    <th>Category</th>
                    <th>Price</th>
                    <th>Stock</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="productsTableBody">
                <tr>
                    <td colspan="6" style="text-align: center; padding: 40px; color: var(--sub);">
                        <i data-lucide="package" style="width: 48px; height: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
                        <p>Loading products...</p>
                    </td>
                </tr>
            </tbody>
        </table>
        <div class="pagination">
            <div class="page-info" id="pageInfo">Showing 0-0 of 0 products</div>
            <div class="page-controls" id="pageControls">
                <!-- Pagination buttons will be added here -->
            </div>
        </div>
    </div>
</div>

<!-- Add Product Modal -->
<div id="addProductModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 1000; align-items: center; justify-content: center;">
    <div style="background: #fff; border-radius: 12px; padding: 24px; width: 500px; max-width: 90vw; max-height: 90vh; overflow-y: auto;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
            <h2 style="margin: 0; color: var(--text);">Add New Product</h2>
            <button onclick="closeAddProductModal()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: var(--sub);">&times;</button>
        </div>
        <form id="addProductForm">
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text);">Product Name *</label>
                <input type="text" id="productName" required style="width: 100%; padding: 10px; border: 1.5px solid var(--border); border-radius: 8px; font-size: 14px;">
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text);">Category</label>
                <input type="text" id="productCategory" style="width: 100%; padding: 10px; border: 1.5px solid var(--border); border-radius: 8px; font-size: 14px;">
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text);">Price (₹)</label>
                <input type="number" id="productPrice" step="0.01" min="0" style="width: 100%; padding: 10px; border: 1.5px solid var(--border); border-radius: 8px; font-size: 14px;">
            </div>
            <div style="margin-bottom: 16px;">
                <label style="display: block; margin-bottom: 8px; font-weight: 600; color: var(--text);">Stock</label>
                <input type="number" id="productStock" min="0" style="width: 100%; padding: 10px; border: 1.5px solid var(--border); border-radius: 8px; font-size: 14px;">
            </div>
            <div style="display: flex; gap: 12px; margin-top: 24px;">
                <button type="button" onclick="closeAddProductModal()" style="flex: 1; padding: 12px; background: #f3f4f6; color: var(--text); border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Cancel</button>
                <button type="submit" style="flex: 1; padding: 12px; background: var(--wine); color: #fff; border: none; border-radius: 8px; font-weight: 600; cursor: pointer;">Add Product</button>
            </div>
        </form>
    </div>
</div>

<script>
let products = [];
let filteredProducts = [];
let currentPage = 1;
const itemsPerPage = 10;

// Load products
async function loadProducts() {
    try {
        const response = await fetch('/api/products');
        if (response.ok) {
            const data = await response.json();
            products = data.products || data;
            updateStats();
            applyFilters();
        } else {
            console.error('Failed to load products:', response.status);
        }
    } catch (error) {
        console.error('Error loading products:', error);
    }
}

// Update statistics
function updateStats() {
    const totalProducts = products.length;
    const activeProducts = products.filter(p => p.is_active !== false).length;
    const lowStock = products.filter(p => p.stock <= (p.min_stock || 0) && p.stock > 0).length;
    const outOfStock = products.filter(p => p.stock == 0 || p.stock == null).length;
    
    document.getElementById('totalProducts').textContent = totalProducts;
    document.getElementById('activeProducts').textContent = activeProducts;
    document.getElementById('lowStock').textContent = lowStock;
    document.getElementById('outOfStock').textContent = outOfStock;
}

// Apply filters
function applyFilters() {
    const category = document.getElementById('categoryFilter').value;
    const status = document.getElementById('statusFilter').value;
    const search = document.getElementById('searchInput').value.toLowerCase();
    
    filteredProducts = products.filter(product => {
        const matchesCategory = !category || product.category === category;
        const matchesStatus = !status || 
            (status === 'active' && product.is_active !== false) ||
            (status === 'inactive' && product.is_active === false);
        const matchesSearch = !search || 
            product.name.toLowerCase().includes(search) ||
            (product.code && product.code.toLowerCase().includes(search));
        
        return matchesCategory && matchesStatus && matchesSearch;
    });
    
    renderTable();
    renderPagination();
}

// Render table
function renderTable() {
    const tbody = document.getElementById('productsTableBody');
    const startIndex = (currentPage - 1) * itemsPerPage;
    const endIndex = startIndex + itemsPerPage;
    const pageProducts = filteredProducts.slice(startIndex, endIndex);
    
    if (pageProducts.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="6" style="text-align: center; padding: 40px; color: var(--sub);">
                    <i data-lucide="package" style="width: 48px; height: 48px; opacity: 0.3; margin-bottom: 12px;"></i>
                    <p>No products found</p>
                </td>
            </tr>
        `;
        lucide.createIcons();
        return;
    }
    
    tbody.innerHTML = pageProducts.map(product => `
        <tr>
            <td>${product.name}</td>
            <td>${product.category || 'Uncategorized'}</td>
            <td>₹${parseFloat(product.price || 0).toFixed(2)}</td>
            <td>${product.stock || 0}</td>
            <td>
                <span class="status-badge ${product.is_active !== false ? 'status-active' : 'status-inactive'}">
                    ${product.is_active !== false ? 'Active' : 'Inactive'}
                </span>
            </td>
            <td>
                <button onclick="editProduct('${product.id}')" style="background: none; border: none; color: var(--wine); cursor: pointer; margin-right: 12px;">
                    <i data-lucide="edit" style="width: 16px; height: 16px;"></i>
                </button>
                <button onclick="deleteProduct('${product.id}')" style="background: none; border: none; color: #EF4444; cursor: pointer;">
                    <i data-lucide="trash-2" style="width: 16px; height: 16px;"></i>
                </button>
            </td>
        </tr>
    `).join('');
    
    lucide.createIcons();
}

// Render pagination
function renderPagination() {
    const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
    const pageInfo = document.getElementById('pageInfo');
    const pageControls = document.getElementById('pageControls');
    
    // Update page info
    const start = (currentPage - 1) * itemsPerPage + 1;
    const end = Math.min(currentPage * itemsPerPage, filteredProducts.length);
    pageInfo.textContent = `Showing ${start}-${end} of ${filteredProducts.length} products`;
    
    // Update pagination buttons
    pageControls.innerHTML = '';
    
    // Previous button
    const prevBtn = document.createElement('button');
    prevBtn.className = 'page-btn';
    prevBtn.innerHTML = '<i data-lucide="chevron-left" style="width: 16px; height: 16px;"></i>';
    prevBtn.disabled = currentPage === 1;
    prevBtn.onclick = () => {
        if (currentPage > 1) {
            currentPage--;
            renderTable();
            renderPagination();
        }
    };
    pageControls.appendChild(prevBtn);
    
    // Page numbers
    for (let i = 1; i <= totalPages; i++) {
        if (i === 1 || i === totalPages || (i >= currentPage - 1 && i <= currentPage + 1)) {
            const pageBtn = document.createElement('button');
            pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
            pageBtn.textContent = i;
            pageBtn.onclick = () => {
                currentPage = i;
                renderTable();
                renderPagination();
            };
            pageControls.appendChild(pageBtn);
        } else if (i === currentPage - 2 || i === currentPage + 2) {
            const ellipsis = document.createElement('span');
            ellipsis.textContent = '...';
            ellipsis.style.padding = '8px 4px';
            ellipsis.style.color = 'var(--sub)';
            pageControls.appendChild(ellipsis);
        }
    }
    
    // Next button
    const nextBtn = document.createElement('button');
    nextBtn.className = 'page-btn';
    nextBtn.innerHTML = '<i data-lucide="chevron-right" style="width: 16px; height: 16px;"></i>';
    nextBtn.disabled = currentPage === totalPages || totalPages === 0;
    nextBtn.onclick = () => {
        if (currentPage < totalPages) {
            currentPage++;
            renderTable();
            renderPagination();
        }
    };
    pageControls.appendChild(nextBtn);
    
    lucide.createIcons();
}

// Modal functions
function showAddProductModal() {
    document.getElementById('addProductModal').style.display = 'flex';
}

function closeAddProductModal() {
    document.getElementById('addProductModal').style.display = 'none';
    document.getElementById('addProductForm').reset();
}

// Form submission
document.getElementById('addProductForm').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const productData = {
        name: document.getElementById('productName').value,
        category: document.getElementById('productCategory').value,
        price: parseFloat(document.getElementById('productPrice').value) || 0,
        stock: parseInt(document.getElementById('productStock').value) || 0
    };
    
    try {
        const response = await fetch('/api/products', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(productData)
        });
        
        if (response.ok) {
            closeAddProductModal();
            loadProducts(); // Reload products
            alert('Product added successfully!');
        } else {
            const error = await response.json();
            alert('Error: ' + (error.error || 'Failed to add product'));
        }
    } catch (error) {
        console.error('Error adding product:', error);
        alert('Network error. Please try again.');
    }
});

// Edit product
function editProduct(productId) {
    alert('Edit product feature coming soon!');
}

// Delete product
async function deleteProduct(productId) {
    if (confirm('Are you sure you want to delete this product?')) {
        try {
            const response = await fetch(`/api/products/${productId}`, {
                method: 'DELETE'
            });
            
            if (response.ok) {
                loadProducts(); // Reload products
                alert('Product deleted successfully!');
            } else {
                const error = await response.json();
                alert('Error: ' + (error.error || 'Failed to delete product'));
            }
        } catch (error) {
            console.error('Error deleting product:', error);
            alert('Network error. Please try again.');
        }
    }
}

// Event listeners
document.getElementById('categoryFilter').addEventListener('change', applyFilters);
document.getElementById('statusFilter').addEventListener('change', applyFilters);
document.getElementById('searchInput').addEventListener('input', applyFilters);

// Initialize
document.addEventListener('DOMContentLoaded', function() {
    lucide.createIcons();
    loadProducts();
});
</script>
{% endblock %}