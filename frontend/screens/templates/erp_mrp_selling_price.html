{% extends "erp_base_layout.html" %}
{% block title %}Price Management - ERP{% endblock %}
{% block extra_css %}
<style>
:root{--wine:#732C3F;--wine-light:#8d3a4f;--bg:#f8f9fa;--text:#1A1A1A;--sub:#6B7280;--border:#e5e7eb;--radius:12px}
.page-wrapper{background:var(--bg);min-height:100vh;padding:24px 20px}
.page-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;gap:16px}
.page-header h1{font-size:28px;font-weight:700;color:var(--text);display:flex;align-items:center;gap:12px;margin:0}
.page-header h1 i{color:var(--wine)}
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:24px}
.stat-card{background:#fff;border-radius:var(--radius);padding:20px;box-shadow:0 1px 3px rgba(0,0,0,0.1);display:flex;align-items:center;gap:16px}
.stat-icon{width:48px;height:48px;border-radius:10px;display:flex;align-items:center;justify-content:center;font-size:24px}
.stat-icon.primary{background:rgba(115,44,63,0.1);color:var(--wine)}
.stat-icon.success{background:rgba(16,185,129,0.1);color:#10b981}
.stat-icon.warning{background:rgba(245,158,11,0.1);color:#f59e0b}
.stat-info .value{font-size:24px;font-weight:700;color:var(--text);margin-bottom:4px}
.stat-info .label{font-size:13px;color:var(--sub);font-weight:500}
.tab-nav{background:#fff;border-radius:var(--radius);padding:8px;display:flex;gap:8px;margin-bottom:24px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.tab-btn{flex:1;padding:12px 20px;border:none;background:transparent;color:var(--sub);font-size:15px;font-weight:600;border-radius:8px;cursor:pointer;transition:all 0.2s;display:flex;align-items:center;justify-content:center;gap:8px}
.tab-btn:hover{background:#f3f4f6}
.tab-btn.active{background:var(--wine);color:white}
.tab-content{display:none}
.tab-content.active{display:block}
.content-card{background:#fff;border-radius:var(--radius);padding:24px;box-shadow:0 1px 3px rgba(0,0,0,0.1)}
.content-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:20px;flex-wrap:wrap;gap:12px}
.content-header h2{font-size:20px;font-weight:600;color:var(--text);margin:0}
.header-actions{display:flex;gap:12px;align-items:center}
.btn{border:none;border-radius:8px;font-size:14px;font-weight:600;cursor:pointer;padding:10px 20px;display:inline-flex;align-items:center;gap:8px;transition:all 0.2s;text-decoration:none}
.btn-primary{background:var(--wine);color:#fff}
.btn-primary:hover{background:var(--wine-light)}
.btn-secondary{background:#f3f4f6;color:var(--text)}
.btn-secondary:hover{background:#e5e7eb}
.btn-sm{padding:6px 12px;font-size:13px}
.search-bar{width:100%;max-width:400px;padding:10px 16px;border:1.5px solid var(--border);border-radius:8px;font-size:14px;transition:all 0.2s}
.search-bar:focus{outline:none;border-color:var(--wine)}
.data-table{width:100%;border-collapse:collapse;margin-top:16px}
.data-table thead{background:#f8f9fa}
.data-table th{padding:12px 16px;text-align:left;font-size:13px;font-weight:600;color:var(--sub);text-transform:uppercase;letter-spacing:0.5px;border-bottom:2px solid var(--border)}
.data-table td{padding:14px 16px;border-bottom:1px solid var(--border);font-size:14px;color:var(--text)}
.data-table tbody tr:hover{background:#f8f9fa}
.badge{display:inline-block;padding:4px 12px;border-radius:12px;font-size:12px;font-weight:600}
.badge-success{background:rgba(16,185,129,0.1);color:#10b981}
.badge-warning{background:rgba(245,158,11,0.1);color:#f59e0b}
.badge-danger{background:rgba(220,38,38,0.1);color:#dc2626}
.action-btns{display:flex;gap:8px}
.icon-btn{width:32px;height:32px;border:none;background:#f3f4f6;border-radius:6px;cursor:pointer;display:flex;align-items:center;justify-content:center;transition:all 0.2s}
.icon-btn:hover{background:var(--wine);color:white}
.empty-state{text-align:center;padding:60px 20px;color:var(--sub)}
.empty-state i{font-size:48px;margin-bottom:16px;opacity:0.5}
.empty-state h3{font-size:18px;margin-bottom:8px;color:var(--text)}
.empty-state p{font-size:14px}
.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);z-index:1000;align-items:center;justify-content:center}
.modal.active{display:flex}
.modal-content{background:white;border-radius:var(--radius);width:90%;max-width:700px;max-height:90vh;overflow-y:auto}
.modal-header{padding:20px 24px;border-bottom:1px solid var(--border);display:flex;justify-content:space-between;align-items:center}
.modal-header h3{font-size:18px;font-weight:600;margin:0}
.modal-body{padding:24px}
.modal-footer{padding:16px 24px;border-top:1px solid var(--border);display:flex;justify-content:flex-end;gap:12px}
.form-group{margin-bottom:20px}
.form-group label{display:block;font-size:14px;font-weight:600;color:var(--text);margin-bottom:8px}
.form-group input,.form-group select,.form-group textarea{width:100%;padding:10px 14px;border:1.5px solid var(--border);border-radius:8px;font-size:14px;transition:all 0.2s}
.form-group input:focus,.form-group select:focus,.form-group textarea:focus{outline:none;border-color:var(--wine)}
.form-row{display:grid;grid-template-columns:1fr 1fr;gap:16px}
.calc-box{background:#f8f9fa;padding:16px;border-radius:8px;margin-top:12px}
.calc-box .calc-row{display:flex;justify-content:space-between;margin-bottom:8px;font-size:14px}
.calc-box .calc-row.total{font-weight:700;font-size:16px;color:var(--wine);border-top:2px solid var(--border);padding-top:8px;margin-top:8px}
@media(max-width:768px){.page-wrapper{padding:16px 12px}.page-header{flex-direction:column;align-items:flex-start}.tab-nav{flex-direction:column}.stats-grid{grid-template-columns:1fr}.content-header{flex-direction:column;align-items:flex-start}.search-bar{max-width:100%}.data-table{font-size:13px}.data-table th,.data-table td{padding:10px 12px}.form-row{grid-template-columns:1fr}}
</style>
{% endblock %}
{% block content %}
<div class="page-wrapper">
<div class="page-header"><h1><i data-lucide="dollar-sign"></i> Price Management</h1></div>
<div class="stats-grid">
<div class="stat-card"><div class="stat-icon primary"><i data-lucide="package"></i></div><div class="stat-info"><div class="value" id="totalProducts">0</div><div class="label">Total Products</div></div></div>
<div class="stat-card"><div class="stat-icon success"><i data-lucide="trending-up"></i></div><div class="stat-info"><div class="value" id="avgMargin">0%</div><div class="label">Avg Margin</div></div></div>
<div class="stat-card"><div class="stat-icon warning"><i data-lucide="edit"></i></div><div class="stat-info"><div class="value" id="priceChanges">0</div><div class="label">Changes Today</div></div></div>
<div class="stat-card"><div class="stat-icon warning"><i data-lucide="tag"></i></div><div class="stat-info"><div class="value" id="discounted">0</div><div class="label">Discounted Items</div></div></div>
</div>
<div class="tab-nav">
<button class="tab-btn active" data-tab="list"><i data-lucide="list"></i>Price List</button>
<button class="tab-btn" data-tab="bulk"><i data-lucide="layers"></i>Bulk Update</button>
<button class="tab-btn" data-tab="rules"><i data-lucide="settings"></i>Price Rules</button>
<button class="tab-btn" data-tab="history"><i data-lucide="clock"></i>History</button>
</div>
<div class="tab-content active" id="list-tab">
<div class="content-card">
<div class="content-header"><h2>Product Price List</h2>
<div class="header-actions">
<input type="text" class="search-bar" id="searchList" placeholder="Search products...">
<select class="search-bar" style="max-width:200px" id="filterMargin"><option value="">All Margins</option><option value="high">High (>30%)</option><option value="medium">Medium (15-30%)</option><option value="low">Low (<15%)</option></select>
<button class="btn btn-secondary" onclick="loadPrices()"><i data-lucide="refresh-cw"></i>Refresh</button>
<button class="btn btn-primary" onclick="openPriceModal()"><i data-lucide="edit"></i>Update Price</button>
</div></div>
<table class="data-table"><thead><tr><th>Product</th><th>Cost Price</th><th>MRP</th><th>Selling Price</th><th>Margin %</th><th>Last Updated</th><th>Actions</th></tr></thead>
<tbody id="priceListBody"><tr><td colspan="7"><div class="empty-state"><i data-lucide="inbox"></i><h3>No Products</h3><p>Product prices will appear here</p></div></td></tr></tbody></table>
</div></div>
<div class="tab-content" id="bulk-tab">
<div class="content-card">
<div class="content-header"><h2>Bulk Price Update</h2></div>
<form id="bulkUpdateForm">
<div class="form-group"><label>Select Products</label><select id="bulkProducts" multiple style="height:120px"><option>All Products</option></select></div>
<div class="form-group"><label>Update Type</label><select id="bulkType"><option value="percentage">Percentage Increase/Decrease</option><option value="fixed">Fixed Amount</option><option value="margin">Set Margin %</option></select></div>
<div class="form-row">
<div class="form-group"><label>Value</label><input type="number" id="bulkValue" step="0.01" placeholder="e.g., 10"></div>
<div class="form-group"><label>Apply To</label><select id="bulkApply"><option value="mrp">MRP</option><option value="selling">Selling Price</option><option value="both">Both</option></select></div>
</div>
<div class="form-group"><label>Reason</label><textarea id="bulkReason" rows="2" placeholder="Reason for price change"></textarea></div>
<div style="display:flex;gap:12px;justify-content:flex-end">
<button type="button" class="btn btn-secondary" onclick="previewBulk()"><i data-lucide="eye"></i>Preview</button>
<button type="submit" class="btn btn-primary"><i data-lucide="check"></i>Apply Changes</button>
</div>
</form>
</div></div>
<div class="tab-content" id="rules-tab">
<div class="content-card">
<div class="content-header"><h2>Pricing Rules</h2>
<div class="header-actions">
<button class="btn btn-primary" onclick="openRuleModal()"><i data-lucide="plus"></i>Add Rule</button>
</div></div>
<table class="data-table"><thead><tr><th>Rule Name</th><th>Type</th><th>Condition</th><th>Action</th><th>Status</th><th>Actions</th></tr></thead>
<tbody id="rulesBody"><tr><td colspan="6"><div class="empty-state"><i data-lucide="settings"></i><h3>No Pricing Rules</h3><p>Create automated pricing rules</p><button class="btn btn-primary" onclick="openRuleModal()"><i data-lucide="plus"></i>Add Rule</button></div></td></tr></tbody></table>
</div></div>
<div class="tab-content" id="history-tab">
<div class="content-card">
<div class="content-header"><h2>Price Change History</h2>
<div class="header-actions">
<input type="text" class="search-bar" id="searchHistory" placeholder="Search...">
<select class="search-bar" style="max-width:200px" id="filterPeriod"><option>Last 7 Days</option><option>Last 30 Days</option><option>Last 3 Months</option></select>
</div></div>
<table class="data-table"><thead><tr><th>Date</th><th>Product</th><th>Old Price</th><th>New Price</th><th>Change</th><th>Reason</th><th>By</th></tr></thead>
<tbody id="historyBody"><tr><td colspan="7"><div class="empty-state"><i data-lucide="clock"></i><h3>No History</h3><p>Price change history will appear here</p></div></td></tr></tbody></table>
</div></div>
</div>
<div class="modal" id="priceModal">
<div class="modal-content">
<div class="modal-header"><h3>Update Product Price</h3><button class="icon-btn" onclick="closePriceModal()"><i data-lucide="x"></i></button></div>
<div class="modal-body">
<form id="priceForm">
<div class="form-group"><label>Select Product *</label><select id="priceProduct" required onchange="loadProductPrice()"><option value="">Select Product</option></select></div>
<div class="form-row">
<div class="form-group"><label>Cost Price</label><input type="number" id="costPrice" step="0.01" placeholder="0.00" onchange="calculateMargin()"></div>
<div class="form-group"><label>MRP *</label><input type="number" id="mrp" required step="0.01" placeholder="0.00" onchange="calculateMargin()"></div>
</div>
<div class="form-row">
<div class="form-group"><label>Selling Price *</label><input type="number" id="sellingPrice" required step="0.01" placeholder="0.00" onchange="calculateMargin()"></div>
<div class="form-group"><label>Discount %</label><input type="number" id="discount" step="0.01" placeholder="0" onchange="applyDiscount()"></div>
</div>
<div class="calc-box">
<div class="calc-row"><span>Cost Price:</span><span id="calcCost">₹0.00</span></div>
<div class="calc-row"><span>MRP:</span><span id="calcMRP">₹0.00</span></div>
<div class="calc-row"><span>Selling Price:</span><span id="calcSelling">₹0.00</span></div>
<div class="calc-row"><span>Discount:</span><span id="calcDiscount">₹0.00</span></div>
<div class="calc-row total"><span>Margin:</span><span id="calcMargin">0%</span></div>
</div>
<div class="form-group"><label>Reason for Change</label><textarea id="priceReason" rows="2" placeholder="Reason for price update"></textarea></div>
</form>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closePriceModal()">Cancel</button>
<button class="btn btn-primary" onclick="savePrice()">Update Price</button>
</div>
</div></div>
<div class="modal" id="ruleModal">
<div class="modal-content">
<div class="modal-header"><h3>Add Pricing Rule</h3><button class="icon-btn" onclick="closeRuleModal()"><i data-lucide="x"></i></button></div>
<div class="modal-body">
<form id="ruleForm">
<div class="form-group"><label>Rule Name *</label><input type="text" id="ruleName" required placeholder="e.g., Seasonal Discount"></div>
<div class="form-group"><label>Rule Type</label><select id="ruleType"><option value="discount">Discount</option><option value="margin">Margin Based</option><option value="competitor">Competitor Based</option></select></div>
<div class="form-group"><label>Condition</label><input type="text" id="ruleCondition" placeholder="e.g., Category = Electronics"></div>
<div class="form-group"><label>Action</label><input type="text" id="ruleAction" placeholder="e.g., Apply 10% discount"></div>
<div class="form-group"><label>Status</label><select id="ruleStatus"><option value="active">Active</option><option value="inactive">Inactive</option></select></div>
</form>
</div>
<div class="modal-footer">
<button class="btn btn-secondary" onclick="closeRuleModal()">Cancel</button>
<button class="btn btn-primary" onclick="saveRule()">Save Rule</button>
</div>
</div></div>
<script>
let priceData=[];
document.querySelectorAll('.tab-btn').forEach(btn=>{btn.addEventListener('click',()=>{const tab=btn.dataset.tab;document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('active'));btn.classList.add('active');document.querySelectorAll('.tab-content').forEach(c=>c.classList.remove('active'));document.getElementById(`${tab}-tab`).classList.add('active');lucide.createIcons()})});
async function loadPrices(){try{const response=await fetch('/api/erp/prices');const data=await response.json();if(data.success){priceData=data.data||[];renderPriceList();renderHistory();updateStats()}}catch(e){console.error('Error:',e)}}
function updateStats(){document.getElementById('totalProducts').textContent=priceData.length;const margins=priceData.map(p=>((p.selling_price-p.cost_price)/p.cost_price*100)||0);const avgMargin=margins.length?margins.reduce((a,b)=>a+b,0)/margins.length:0;document.getElementById('avgMargin').textContent=avgMargin.toFixed(1)+'%';document.getElementById('priceChanges').textContent=0;document.getElementById('discounted').textContent=priceData.filter(p=>p.discount>0).length}
function renderPriceList(){const tbody=document.getElementById('priceListBody');if(priceData.length===0){tbody.innerHTML='<tr><td colspan="7"><div class="empty-state"><i data-lucide="inbox"></i><h3>No Products</h3><p>Product prices will appear here</p></div></td></tr>'}else{tbody.innerHTML=priceData.map(p=>{const margin=((p.selling_price-p.cost_price)/p.cost_price*100)||0;let marginClass='success';if(margin<15)marginClass='danger';else if(margin<30)marginClass='warning';return`<tr><td><strong>${p.product_name}</strong></td><td>₹${p.cost_price||0}</td><td>₹${p.mrp||0}</td><td>₹${p.selling_price||0}</td><td><span class="badge badge-${marginClass}">${margin.toFixed(1)}%</span></td><td>${p.last_updated||'-'}</td><td><div class="action-btns"><button class="icon-btn" onclick="editPrice('${p.id}')" title="Edit"><i data-lucide="edit-2"></i></button><button class="icon-btn" onclick="viewHistory('${p.id}')" title="History"><i data-lucide="clock"></i></button></div></td></tr>`}).join('')}lucide.createIcons()}
function renderHistory(){const tbody=document.getElementById('historyBody');tbody.innerHTML='<tr><td colspan="7"><div class="empty-state"><i data-lucide="clock"></i><h3>No History</h3><p>Price change history will appear here</p></div></td></tr>';lucide.createIcons()}
function openPriceModal(){document.getElementById('priceModal').classList.add('active');lucide.createIcons()}
function closePriceModal(){document.getElementById('priceModal').classList.remove('active')}
function loadProductPrice(){calculateMargin()}
function calculateMargin(){const cost=parseFloat(document.getElementById('costPrice').value)||0;const mrp=parseFloat(document.getElementById('mrp').value)||0;const selling=parseFloat(document.getElementById('sellingPrice').value)||0;const discount=parseFloat(document.getElementById('discount').value)||0;document.getElementById('calcCost').textContent='₹'+cost.toFixed(2);document.getElementById('calcMRP').textContent='₹'+mrp.toFixed(2);document.getElementById('calcSelling').textContent='₹'+selling.toFixed(2);document.getElementById('calcDiscount').textContent='₹'+(mrp-selling).toFixed(2);const margin=cost>0?((selling-cost)/cost*100):0;document.getElementById('calcMargin').textContent=margin.toFixed(1)+'%'}
function applyDiscount(){const mrp=parseFloat(document.getElementById('mrp').value)||0;const discount=parseFloat(document.getElementById('discount').value)||0;const selling=mrp-(mrp*discount/100);document.getElementById('sellingPrice').value=selling.toFixed(2);calculateMargin()}
async function savePrice(){const data={product_id:document.getElementById('priceProduct').value,cost_price:parseFloat(document.getElementById('costPrice').value),mrp:parseFloat(document.getElementById('mrp').value),selling_price:parseFloat(document.getElementById('sellingPrice').value),discount:parseFloat(document.getElementById('discount').value)||0,reason:document.getElementById('priceReason').value};if(!data.product_id||!data.mrp||!data.selling_price){alert('Please fill required fields');return}try{const response=await fetch('/api/erp/prices',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(data)});const result=await response.json();if(result.success){closePriceModal();loadPrices();alert('Price updated')}}catch(e){console.error('Error:',e);alert('Failed to update')}}
function editPrice(id){alert('Edit price for product '+id)}
function viewHistory(id){alert('View price history for product '+id)}
function previewBulk(){alert('Preview bulk price changes')}
function openRuleModal(){document.getElementById('ruleModal').classList.add('active');lucide.createIcons()}
function closeRuleModal(){document.getElementById('ruleModal').classList.remove('active')}
function saveRule(){alert('Save pricing rule')}
document.getElementById('bulkUpdateForm').addEventListener('submit',(e)=>{e.preventDefault();alert('Apply bulk price update')});
['searchList','searchHistory'].forEach(id=>{const el=document.getElementById(id);if(el){el.addEventListener('input',(e)=>{const search=e.target.value.toLowerCase();const tbody=e.target.closest('.content-card').querySelector('tbody');const rows=tbody.querySelectorAll('tr');rows.forEach(row=>{const text=row.textContent.toLowerCase();row.style.display=text.includes(search)?'':'none'})})}});
document.addEventListener('DOMContentLoaded',function(){loadPrices();lucide.createIcons()});
</script>
{% endblock %}
