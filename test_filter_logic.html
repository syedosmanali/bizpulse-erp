<!DOCTYPE html>
<html>
<head>
    <title>Sales Filter Logic Test</title>
    <style>
        body { font-family: Arial, sans-serif; padding: 20px; }
        .test-section { background: #f5f5f5; padding: 15px; margin: 10px 0; border-radius: 5px; }
        .result { background: #e8f5e8; padding: 10px; margin: 5px 0; border-radius: 3px; }
        .error { background: #ffe8e8; padding: 10px; margin: 5px 0; border-radius: 3px; }
        button { padding: 10px 15px; margin: 5px; cursor: pointer; }
        select { padding: 5px; margin: 5px; }
    </style>
</head>
<body>
    <h1>üîç Sales Filter Logic Test</h1>
    
    <div class="test-section">
        <h3>Current Date Info:</h3>
        <div id="dateInfo"></div>
    </div>
    
    <div class="test-section">
        <h3>Mock Sales Data:</h3>
        <div id="salesData"></div>
    </div>
    
    <div class="test-section">
        <h3>Filter Test:</h3>
        <select id="testFilter" onchange="testFilter()">
            <option value="today">Today</option>
            <option value="yesterday">Yesterday</option>
        </select>
        <button onclick="testFilter()">Apply Filter</button>
        <div id="filterResults"></div>
    </div>
    
    <div class="test-section">
        <h3>Real API Test:</h3>
        <button onclick="testRealAPI()">Load Real Sales Data</button>
        <div id="apiResults"></div>
    </div>
    
    <script>
        // Mock sales data (same as what API returns)
        const mockSales = [
            { sale_date: '2025-12-19 10:30:00', product_name: 'Tea 250g', total_price: 800 },
            { sale_date: '2025-12-18 22:18:48', product_name: 'Rice 1kg', total_price: 80 },
            { sale_date: '2025-12-18 00:16:07', product_name: 'Rice 1kg', total_price: 80 },
            { sale_date: '2025-12-17 23:48:52', product_name: 'Rice 1kg', total_price: 80 },
            { sale_date: '2025-12-17 23:48:52', product_name: 'Tea 250g', total_price: 200 }
        ];
        
        // Show current date info
        const today = new Date();
        const todayStr = today.toISOString().split('T')[0];
        const yesterday = new Date(today);
        yesterday.setDate(today.getDate() - 1);
        const yesterdayStr = yesterday.toISOString().split('T')[0];
        
        document.getElementById('dateInfo').innerHTML = `
            <strong>JavaScript Today:</strong> ${todayStr}<br>
            <strong>JavaScript Yesterday:</strong> ${yesterdayStr}<br>
            <strong>Full Date Object:</strong> ${today}
        `;
        
        // Show mock sales data
        document.getElementById('salesData').innerHTML = mockSales.map(sale => 
            `${sale.sale_date} - ${sale.product_name} - ‚Çπ${sale.total_price}`
        ).join('<br>');
        
        function testFilter() {
            const filterType = document.getElementById('testFilter').value;
            console.log(`üîç Testing ${filterType} filter`);
            
            let targetDate;
            if (filterType === 'today') {
                targetDate = todayStr;
            } else if (filterType === 'yesterday') {
                targetDate = yesterdayStr;
            }
            
            console.log(`üìÖ Target date: ${targetDate}`);
            
            // Apply the same filtering logic as the main page
            const filteredSales = mockSales.filter(sale => {
                const saleDate = sale.sale_date ? sale.sale_date.split(' ')[0] : '';
                const matches = saleDate === targetDate;
                console.log(`   ${saleDate} === ${targetDate} ? ${matches}`);
                return matches;
            });
            
            const total = filteredSales.reduce((sum, sale) => sum + sale.total_price, 0);
            
            document.getElementById('filterResults').innerHTML = `
                <div class="result">
                    <strong>${filterType.toUpperCase()} Filter Results:</strong><br>
                    Target Date: ${targetDate}<br>
                    Sales Found: ${filteredSales.length}<br>
                    Total Amount: ‚Çπ${total}<br>
                    Sales: ${filteredSales.map(s => s.product_name).join(', ') || 'None'}
                </div>
            `;
        }
        
        async function testRealAPI() {
            try {
                console.log('üìä Loading real API data...');
                const response = await fetch('/api/sales?per_page=100');
                const data = await response.json();
                const sales = data.sales || data;
                
                // Test today filter
                const todaySales = sales.filter(sale => {
                    const saleDate = sale.sale_date ? sale.sale_date.split(' ')[0] : '';
                    return saleDate === todayStr;
                });
                
                // Test yesterday filter
                const yesterdaySales = sales.filter(sale => {
                    const saleDate = sale.sale_date ? sale.sale_date.split(' ')[0] : '';
                    return saleDate === yesterdayStr;
                });
                
                const todayTotal = todaySales.reduce((sum, sale) => sum + (sale.total_price || 0), 0);
                const yesterdayTotal = yesterdaySales.reduce((sum, sale) => sum + (sale.total_price || 0), 0);
                
                document.getElementById('apiResults').innerHTML = `
                    <div class="result">
                        <strong>REAL API Results:</strong><br>
                        Total Sales Loaded: ${sales.length}<br><br>
                        
                        <strong>Today (${todayStr}):</strong><br>
                        Count: ${todaySales.length}<br>
                        Total: ‚Çπ${todayTotal}<br>
                        Products: ${todaySales.map(s => s.product_name).join(', ') || 'None'}<br><br>
                        
                        <strong>Yesterday (${yesterdayStr}):</strong><br>
                        Count: ${yesterdaySales.length}<br>
                        Total: ‚Çπ${yesterdayTotal}<br>
                        Products: ${yesterdaySales.map(s => s.product_name).join(', ') || 'None'}
                    </div>
                `;
                
            } catch (error) {
                document.getElementById('apiResults').innerHTML = `
                    <div class="error">Error loading API data: ${error.message}</div>
                `;
            }
        }
        
        // Auto-run tests
        console.log('üöÄ Running automatic filter tests...');
        testFilter(); // Test today by default
    </script>
</body>
</html>